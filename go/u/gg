#!/bin/bash

path_to_mlr="./mlr"
indir="./regtest/input"

#go build mlr.go
if [ $? -ne 0 ]; then
  exit 1
fi

# ----------------------------------------------------------------
run_mlr() {
  echo
  echo ---------------------------------------------------------------- "$@"
  echo $path_to_mlr "$@"
  echo
  $path_to_mlr "$@"
}

# ----------------------------------------------------------------
mlr_expect_fail() {
  echo
  echo $path_to_mlr "$@"
  echo
  $path_to_mlr "$@"
  status=$?
  if [ $status -eq 0 ]; then
    echo "failed to fail"
  fi
}

# ----------------------------------------------------------------
run_cat() {
  echo
  echo cat "$@"
  echo
  cat "$@"
}

# ----------------------------------------------------------------
announce() {
  echo
  echo "================================================================"
  echo
  echo "$@"
}

# ----------------------------------------------------------------
mention() {
  echo
  echo ---------------------------------------------------------------- "$@"
}

# ================================================================

echo "======================================================================== 0"
path_to_mlr="../c/mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { dump }' s
path_to_mlr="./mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { dump }' s

echo "======================================================================== 1 GOOD"
path_to_mlr="../c/mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emit @sum, "a" }' s
path_to_mlr="./mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emit @sum, "a" }' s

echo "======================================================================== 2 DIFFERENT SHAPES"
path_to_mlr="../c/mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emit @sum }' s
path_to_mlr="./mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emit @sum }' s

echo "======================================================================== 3 GOOD"
path_to_mlr="../c/mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum, "a" }' s
path_to_mlr="./mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum, "a" }' s

echo "======================================================================== 4 GOOD"
path_to_mlr="../c/mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum }' s
path_to_mlr="./mlr"
run_mlr --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum }' s

echo "======================================================================== 5 GOOD"
path_to_mlr="../c/mlr"
run_mlr --oxtab --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum }' s
path_to_mlr="./mlr"
run_mlr --oxtab --oxtab put -q '@sum[$a][$b] += $x; end { emitp @sum }' s

echo "======================================================================== 6 GOOD"
path_to_mlr="../c/mlr"
run_mlr --ojson --jvstack put -q '@sum[$a][$b] += $x; end { emitp @* }' s
path_to_mlr="./mlr"
run_mlr --ojson --jvstack put -q '@sum[$a][$b] += $x; end { emitp @* }' s

echo "======================================================================== 7 EMITP OUTPUT HAS LEADING UNDERSCORE"
path_to_mlr="../c/mlr"
run_mlr --ojson --jvstack put -q '@sum[$a][$b] += $x; end { emitp @*, "prefix" }' s
path_to_mlr="./mlr"
run_mlr --ojson --jvstack put -q '@sum[$a][$b] += $x; end { emitp @*, "prefix" }' s

# ================================================================
